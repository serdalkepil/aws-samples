AWSTemplateFormatVersion: '2010-09-09'
Description: ASG with t4g.micro (ARM), ALB, and CPU Target Tracking Scaling.

Parameters:
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: Select the VPC for deployment.
  
  SubnetIds:
    Type: List<AWS::EC2::Subnet::Id>
    Description: Select at least two subnets (ideally public for this demo).

  LatestArmAmiId:
    Type: 'AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>'
    Default: '/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-6.1-arm64'
    Description: Auto-resolves to the latest Amazon Linux 2023 (ARM64) AMI.

Resources:
  # -------------------------------------------------------------------------
  # SECURITY GROUPS
  # -------------------------------------------------------------------------
  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow HTTP traffic from the Internet
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0

  InstanceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow HTTP traffic only from the ALB
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          SourceSecurityGroupId: !Ref ALBSecurityGroup

  # -------------------------------------------------------------------------
  # LOAD BALANCER (ALB)
  # -------------------------------------------------------------------------
  LoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub "${AWS::StackName}-alb"
      Scheme: internet-facing
      Subnets: !Ref SubnetIds
      SecurityGroups:
        - !Ref ALBSecurityGroup

  TargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub "${AWS::StackName}-tg"
      Port: 80
      Protocol: HTTP
      VpcId: !Ref VpcId
      TargetType: instance
      HealthCheckPath: /
      HealthCheckIntervalSeconds: 30
      Matcher:
        HttpCode: 200

  Listener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref TargetGroup
      LoadBalancerArn: !Ref LoadBalancer
      Port: 80
      Protocol: HTTP

  # -------------------------------------------------------------------------
  # LAUNCH TEMPLATE
  # -------------------------------------------------------------------------
  LaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: !Sub "${AWS::StackName}-lt"
      LaunchTemplateData:
        ImageId: !Ref LatestArmAmiId
        InstanceType: t4g.micro
        # NETWORK CONFIGURATION CHANGE:
        NetworkInterfaces: 
          - DeviceIndex: 0
            AssociatePublicIpAddress: true
            Groups: 
              - !Ref InstanceSecurityGroup
        # Note: When using NetworkInterfaces, SecurityGroupIds must be moved inside it (as shown above), 
        # NOT at the LaunchTemplateData root level.
        UserData:
          Fn::Base64: |
            #!/bin/bash
            # Redirect logs to console for easier debugging
            exec > >(tee /var/log/user-data.log|logger -t user-data -s 2>/dev/console) 2>&1
            
            dnf update -y
            dnf install -y httpd
            systemctl start httpd
            systemctl enable httpd
            
            # IMDSv2 Token & Metadata
            TOKEN=`curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600"`
            INSTANCE_ID=$(curl -H "X-aws-ec2-metadata-token: $TOKEN" -s http://169.254.169.254/latest/meta-data/instance-id)
            AZ=$(curl -H "X-aws-ec2-metadata-token: $TOKEN" -s http://169.254.169.254/latest/meta-data/placement/availability-zone)
            
            COLOR=$(printf "#%06x" $((RANDOM*16777216/32767)))
            
            cat <<EOF > /var/www/html/index.html
            <html>
            <head>
              <title>ASG Demo</title>
              <style>body { background-color: $COLOR; font-family: sans-serif; text-align: center; padding-top: 50px; }</style>
            </head>
            <body>
              <h1>CloudFormation ASG Demo</h1>
              <p>Instance: $INSTANCE_ID</p>
              <p>AZ: $AZ</p>
            </body>
            </html>
            EOF

  # -------------------------------------------------------------------------
  # AUTO SCALING GROUP
  # -------------------------------------------------------------------------
  AutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      AutoScalingGroupName: !Sub "${AWS::StackName}-asg"
      VPCZoneIdentifier: !Ref SubnetIds
      LaunchTemplate:
        LaunchTemplateId: !Ref LaunchTemplate
        Version: !GetAtt LaunchTemplate.LatestVersionNumber
      MinSize: 2
      MaxSize: 5
      DesiredCapacity: 2
      TargetGroupARNs:
        - !Ref TargetGroup
      HealthCheckType: ELB
      HealthCheckGracePeriod: 300

  # -------------------------------------------------------------------------
  # SCALING POLICY (Target Tracking)
  # -------------------------------------------------------------------------
  CPUScalingPolicy:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AutoScalingGroupName: !Ref AutoScalingGroup
      PolicyType: TargetTrackingScaling
      TargetTrackingConfiguration:
        PredefinedMetricSpecification:
          PredefinedMetricType: ASGAverageCPUUtilization
        TargetValue: 50.0

Outputs:
  LoadBalancerDNS:
    Description: Access the web server here
    Value: !GetAtt LoadBalancer.DNSName